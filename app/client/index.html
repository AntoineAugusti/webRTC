<!DOCTYPE html>

<meta charset="utf-8" />

<title>WebSocket Test</title>

<script src="signalingChannelFactory.js">

</script>
<script language="javascript" type="text/javascript">

var wsUri = "ws://localhost:8090/";
var signalingChannel;
function init(){
    RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription;
    RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
    signalingChannel = createSignalingChannel(wsUri);
    var pc;
    var servers = {
    iceServers: [{url: "stun:stun.1.google.com:19302"}]   
    };
    
    // run start(true, <id of the peer you want to communicate with>) to initiate a call
    function start(isCaller, peerId) {
        pc = new RTCPeerConnection(servers, {
            optional: [{
                DtlsSrtpKeyAgreement: true
            }]
        });
            
        pc.onicecandidate = function (evt) {
            if(evt.candidate){ // empty candidate (wirth evt.candidate === null) are often generated
                signalingChannel.sendICECandidate(evt.candidate, peerId);
            }
        };
        
        sendChannel = pc.createDataChannel("sendDataChannel", {reliable: true});
        
        pc.ondatachannel = function(event) {
          receiveChannel = event.channel;
          console.log("channel received")
          receiveChannel.onmessage = function(event){
            console.log("data",event.data);
          };
        };
        
        pc.ondatachannel = function(){
            console.log("on dataChannel trigered");
        };
        
        var _commChannel = pc.createDataChannel('communication', {
            reliable: false
        });
        
        //_commChannel.binaryType = "arraybuffer";
        
        _commChannel.onclose = function(evt) {
            console.log("dataChannel closed");
        }
        _commChannel.onerror = function(evt) {
            console.error("dataChannel error");
        }
        console.log(_commChannel.label);
        
        console.log(_commChannel.readyState);
        
        _commChannel.onopen = function(){
            console.log("dataChannel opened")
        };
        
        window.channel = _commChannel;
        //_commChannel.send('canche');
        
        if (isCaller){
            pc.createOffer(function(offer){
                pc.setLocalDescription(offer);
                console.log('send offer');
                signalingChannel.sendOffer(offer, peerId);
            });
        }
    }
        
    signalingChannel.onOffer = function (offer, source) {
        start(false, source);
        pc.setRemoteDescription(new RTCSessionDescription(offer));
        console.log('receive offer');
        pc.createAnswer(function(answer){
            pc.setLocalDescription(answer);
            console.log('send answer');
            signalingChannel.sendAnswer(answer, source);
        });
    };
    
    signalingChannel.onAnswer = function (answer, source) {
        console.log('receive answer');
        pc.setRemoteDescription(new RTCSessionDescription(answer));
    };
    
    signalingChannel.onICECandidate = function (ICECandidate, source) {
        pc.addIceCandidate(new RTCIceCandidate(ICECandidate));
    };
    
    window.start = start;
    
}
window.addEventListener("load", init, false);

</script>

<h2>WebSocket Test</h2>
